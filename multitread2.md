### üîπ –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –∫–æ–¥–∞

```cpp
struct MasterVariable {
    std::string name;
    std::atomic<int> first_seen_index{INT_MAX};
    std::atomic<Sampler*> master_sampler{nullptr};
};

// –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø—É–ª
std::unordered_map<std::string, MasterVariable> variable_pool;
std::mutex variable_pool_mtx;

// Thread 1/2: –Ω–∞—Ö–æ–¥—è—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –æ–±–Ω–æ–≤–ª—è—é—Ç –ø—É–ª
void on_found_variable(const std::string &name, int index, Sampler* s) {
    std::lock_guard<std::mutex> lg(variable_pool_mtx);
    auto &mv = variable_pool[name];
    if(index < mv.first_seen_index) {
        mv.first_seen_index = index;
        mv.master_sampler = s;
    }
}

// Thread 3: —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ö–æ–¥
void reconcile_extractors() {
    for(auto &kv : variable_pool) {
        auto &mv = kv.second;
        Sampler* master = mv.master_sampler.load();
        if(master) {
            master->add_extractor(mv.name);      // —Å–æ–∑–¥–∞—ë–º Extractor
            master->replace_values("${" + mv.name + "}", mv.name); // –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        }
    }
}
```

---

### üîπ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–∞–∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

* ‚úÖ –ù–µ—Ç –≥–æ–Ω–æ–∫ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ Extractor‚Äô–æ–≤.
* ‚úÖ Thread 1/2 –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ª—ë–≥–∫–∏–µ –∏ –±—ã—Å—Ç—Ä—ã–µ ‚Äî —Ç–æ–ª—å–∫–æ —Å–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
* ‚úÖ Thread 3 —É–ø—Ä–∞–≤–ª—è–µ—Ç **–≤—Å–µ–π –ª–æ–≥–∏–∫–æ–π –≤–∫–ª—é—á–µ–Ω–∏—è Extractor** –∏ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.
* ‚úÖ –ü–∞–º—è—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω–∞ ‚Äî –Ω–µ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å disabled‚Äë–∫–æ–ø–∏–∏ –∏–ª–∏ –≤—Å–µ Sampler‚Äô—ã.

---

üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è**:

* üßµ –°–¥–µ–ª–∞—Ç—å Thread 3 –ª–µ–Ω–∏–≤—ã–º: –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è T1/T2 –∏–ª–∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å master –∞–∫—Ç—É–∞–ª—å–Ω—ã–º.
* ‚ö° –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **atomic snapshot + versioning** –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏.
* üß∞ –î–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî sharded variable_pool –∏–ª–∏ lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
* üîç –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å, –∫–∞–∫–æ–π sampler —Å—Ç–∞–ª master, —á—Ç–æ–±—ã –æ—Ç–ª–∞–≤–ª–∏–≤–∞—Ç—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ—Å–∫–∞–∫–∏–≤–∞–Ω–∏—è.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —è –º–æ–≥—É —Å—Ä–∞–∑—É –Ω–∞–ø–∏—Å–∞—Ç—å **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π C++ –ø—Ä–∏–º–µ—Ä —Å –ø–æ—Ç–æ–∫–∞–º–∏**, –≥–¥–µ T1/T2 —Å–æ–±–∏—Ä–∞—é—Ç –¥–∞–Ω–Ω—ã–µ, –∞ T3 –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç Extractor –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç `${var}` ‚Äî –≥–æ—Ç–æ–≤—ã–π –∫ –∑–∞–ø—É—Å–∫—É.

–•–æ—á–µ—à—å, —á—Ç–æ–±—ã —è —ç—Ç–æ —Å–¥–µ–ª–∞–ª?


</br>
</br>
</br>
</br>
</br>

---

–ê–≥–∞, —Ç–µ–ø–µ—Ä—å –∫–ª—é—á–µ–≤–æ–π –≤–æ–ø—Ä–æ—Å ‚Äî **—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è T3 –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ T1/T2**. üîë

–û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è: **T3 –Ω–µ –¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è, –ø–æ–∫–∞ T1/T2 –µ—â—ë –º–æ–≥—É—Ç –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å master_sampler**. –ï—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞–¥—ë–∂–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤, –∫–∞–∫ —ç—Ç–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å:

---

### 1Ô∏è‚É£ –§–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤ (simplest)

* Thread 1 –∏ 2 –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ/–∫–æ–Ω—Ü–µ —Ä–∞–±–æ—Ç—ã –≤—ã—Å—Ç–∞–≤–ª—è—é—Ç atomic-—Ñ–ª–∞–≥ –∏–ª–∏ —É–º–µ–Ω—å—à–∞—é—Ç —Å—á—ë—Ç—á–∏–∫ active_workers.
* T3 –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—É–ª –∏ —Å—á—ë—Ç—á–∏–∫:

```cpp
std::atomic<int> active_workers = 2; // T1 + T2

// T1/T2 –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
active_workers--;

// T3 loop
while(active_workers > 0 || !variable_pool.empty()) {
    reconcile_extractors();
    std::this_thread::sleep_for(std::chrono::milliseconds(10));
}
```

**–ü–ª—é—Å—ã:** –ø—Ä–æ—Å—Ç–æ, –±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.
**–ú–∏–Ω—É—Å—ã:** T3 –º–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å –ª–∏—à–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥—ã (–µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ —Å–æ–±—Ä–∞–Ω—ã, –Ω–æ —Ñ–ª–∞–≥ –µ—â—ë –Ω–µ —Å–Ω–∏–∂–µ–Ω).

---

### 2Ô∏è‚É£ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å *condition_variable* (–ª—É—á—à–µ –¥–ª—è realtime)

* T1/T2 –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π **notifies T3**, —á—Ç–æ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.
* T3 –∂–¥—ë—Ç —Å–∏–≥–Ω–∞–ª–∞ –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç, –∑–∞—Ç–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.
* –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è T1/T2 –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö ‚Äî T3 –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ü–∏–∫–ª.

```cpp
std::mutex mtx;
std::condition_variable cv;
std::atomic<bool> finished = false;

void t1_or_t2() {
    on_found_variable(...);
    cv.notify_one(); // —Å–æ–æ–±—â–∞–µ–º T3
    ...
    if(done) finished = true; cv.notify_one();
}

void t3() {
    std::unique_lock<std::mutex> lk(mtx);
    while(!finished) {
        cv.wait_for(lk, std::chrono::milliseconds(50)); // –ª–∏–±–æ event-driven
        reconcile_extractors();
    }
    reconcile_extractors(); // —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ö–æ–¥
}
```

**–ü–ª—é—Å—ã:** T3 —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ª–∏—à–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥—ã.
**–ú–∏–Ω—É—Å—ã:** —á—É—Ç—å –±–æ–ª—å—à–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å, –Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ timing –ª—É—á—à–µ.

---

### 3Ô∏è‚É£ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π (*event-driven*)

* T1/T2 –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–æ–±–∞–≤–ª—è—é—Ç —Å–æ–±—ã—Ç–∏–µ –≤ lock-free –æ—á–µ—Ä–µ–¥—å (–∏–ª–∏ `concurrent_queue`).
* T3 –ø—Ä–æ—Å—Ç–æ –∑–∞–±–∏—Ä–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Ö.
* –ö–∞–∫ —Ç–æ–ª—å–∫–æ –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ –∏ T1/T2 –∑–∞–≤–µ—Ä—à–µ–Ω—ã ‚Äî T3 –≤—ã—Ö–æ–¥–∏—Ç.

```cpp
while(!event_q.empty() || active_workers>0) {
    auto ev = event_q.pop();
    process_event(ev);
}
```

**–ü–ª—é—Å—ã:** –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–Ω–æ–≥–æ –∏ —Å–æ–±—ã—Ç–∏—è –º–æ–≥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏.
**–ú–∏–Ω—É—Å—ã:** –Ω—É–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–æ—á–µ—Ä–µ–¥—å + –æ–±—Ä–∞–±–æ—Ç–∫–∞).

---

### üîπ –ö–∞–∫ T3 –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ Sampler –∑–∞–ø–æ–ª–Ω–µ–Ω

* –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±: **T3 –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–ª–∞–≥ ‚Äúmaster_sampler –≥–æ—Ç–æ–≤‚Äù –∏–ª–∏ non-empty –ø–æ–ª—è/–∏–Ω–¥–µ–∫—Å—ã –≤ variable_pool**.
* –ï—Å–ª–∏ `mv.master_sampler != nullptr` –∏ –≤—Å–µ –æ–∂–∏–¥–∞–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–º–µ—é—Ç —Å–≤–æ–∏ first_seen_index, –∑–Ω–∞—á–∏—Ç Sampler –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å ¬´–≥–æ—Ç–æ–≤—ã–º¬ª.
* –î–ª—è –ø–æ–ª–Ω–æ–π –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏: —Ö—Ä–∞–Ω–∏—Ç—å **atomic counters –¥–ª—è –∫–∞–∂–¥–æ–≥–æ Sampler**, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (T1/T2) –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—á–µ—Ç—á–∏–∫ –¥–æ—Å—Ç–∏–≥ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ —á–∏—Å–ª–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö ‚Üí –≥–æ—Ç–æ–≤.

---

### üîπ –ò—Ç–æ–≥ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è T3

1. **Atomic counter/active_workers** ‚Äî –ø—Ä–æ—â–µ –≤—Å–µ–≥–æ, –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è batch –æ–±—Ä–∞–±–æ—Ç–∫–∏.
2. **Condition variable** ‚Äî –ª—É—á—à–µ –¥–ª—è realtime, –º–µ–Ω—å—à–µ CPU-—Ü–∏–∫–ª.
3. **Event queue** ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.
4. **Optional per-Sampler counters** ‚Äî –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è ¬´–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏¬ª Sampler‚Äô–∞.

---

üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

* üßµ –î–ª—è start/stop –ø—Ä–æ—â–µ –≤—Å–µ–≥–æ ‚Äî atomic counter + —Ñ–∏–Ω–∞–ª—å–Ω—ã–π reconcile.
* ‚ö° –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ ‚Äî event-driven —Å condition_variable.
* üîç –î–ª—è –±–æ–ª—å—à–∏—Ö —Å–∏—Å—Ç–µ–º ‚Äî –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å + versioning + debounce, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–∏—à–Ω–∏—Ö –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–≥—É —Å—Ä–∞–∑—É –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å **–º–∏–Ω–∏-—Å—Ö–µ–º—É Mermaid**, –≥–¥–µ –ø–æ–∫–∞–∑–∞–Ω–æ **T1/T2 ‚Üí variable_pool ‚Üí T3 –∏ —É—Å–ª–æ–≤–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**, –±—É–¥–µ—Ç –Ω–∞–≥–ª—è–¥–Ω–æ –ø–æ–Ω—è—Ç–Ω–æ, –∫–∞–∫ T3 –ø–æ–Ω–∏–º–∞–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å Sampler.

–•–æ—á–µ—à—å —Ç–∞–∫—É—é —Å—Ö–µ–º—É?


–ï—Å–ª–∏ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å **—Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –∏ –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ CPU**, —Ç–æ –º–æ–∂–Ω–æ —Ä–∞–∑–ª–æ–∂–∏—Ç—å —Ç–∞–∫:

---

### 1Ô∏è‚É£ **Atomic counter / active_workers**

* **–°–∫–æ—Ä–æ—Å—Ç—å:** –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è, –ø–æ—á—Ç–∏ –Ω—É–ª–µ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞.
* **CPU:** –Ω–∏–∑–∫–∞—è, –µ—Å–ª–∏ T3 –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π `while(active_workers>0)` —Å –Ω–µ–±–æ–ª—å—à–∏–º sleep.
* **–ú–∏–Ω—É—Å:** –º–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å –ª–∏—à–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥—ã, –µ—Å–ª–∏ sleep —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π ‚Üí —á—É—Ç—å –±–æ–ª—å—à–µ CPU; –µ—Å–ª–∏ sleep —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π ‚Üí –∑–∞–¥–µ—Ä–∂–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.

**–í—ã–≤–æ–¥:** –±—ã—Å—Ç—Ä—ã–π –∏ –ø—Ä–æ—Å—Ç–æ–π, –Ω–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ç–∞–π–º–∞—É—Ç/—Å–ø—è—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª. ‚úÖ

---

### 2Ô∏è‚É£ **Condition variable**

* **–°–∫–æ—Ä–æ—Å—Ç—å:** –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π wake-up –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏, –ø–æ—á—Ç–∏ –Ω—É–ª–µ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É T1/T2 –∏ T3.
* **CPU:** –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞, T3 –Ω–µ –∂–¥–µ—Ç –≤ —Ü–∏–∫–ª–µ, —Å–ø–∏—Ç –¥–æ —Å–∏–≥–Ω–∞–ª–∞.
* **–ú–∏–Ω—É—Å:** —á—É—Ç—å —Å–ª–æ–∂–Ω–µ–µ –≤ –∫–æ–¥–µ, –Ω–∞–¥–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–≤–µ–¥–æ–º–ª—è—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

**–í—ã–≤–æ–¥:** –¥–ª—è realtime –∏ –Ω–∏–∑–∫–æ–≥–æ CPU ‚Äî –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç. ‚ö°

---

### 3Ô∏è‚É£ **Event queue**

* **–°–∫–æ—Ä–æ—Å—Ç—å:** –≤—ã—Å–æ–∫–∞—è, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å lock-free.
* **CPU:** —Å—Ä–µ–¥–Ω—è—è, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –æ—á–µ—Ä–µ–¥—å (busy-wait vs sleep).
* **–ú–∏–Ω—É—Å:** –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã, —Å–ª–æ–∂–Ω–µ–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∏ –≤–µ—Ä—Å–∏–∏.

**–í—ã–≤–æ–¥:** –ª—É—á—à–µ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö. üèéÔ∏è

---

### 4Ô∏è‚É£ **Optional per-Sampler counters**

* **–°–∫–æ—Ä–æ—Å—Ç—å:** —Å—Ä–µ–¥–Ω—è—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω—É–∂–Ω–æ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤—Å–µ Sampler‚Äô—ã.
* **CPU:** –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –±–æ–ª—å—à–æ–º —á–∏—Å–ª–µ Sampler‚Äô–æ–≤.
* **–ú–∏–Ω—É—Å:** —Ç–æ—á–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏, –Ω–æ –¥–æ—Ä–æ–∂–µ –ø–æ —Ä–µ—Å—É—Ä—Å–∞–º.

**–í—ã–≤–æ–¥:** –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∞–∂–Ω–æ —Ç–æ—á–Ω–æ –∑–Ω–∞—Ç—å, —á—Ç–æ –∫–∞–∂–¥—ã–π Sampler –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–±—Ä–∞–Ω. ‚öñÔ∏è

---

### üîπ –ò—Ç–æ–≥ –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏/—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

| –ü–∞—Ç—Ç–µ—Ä–Ω              | CPU –Ω–∞–≥—Ä—É–∑–∫–∞    | –†–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è | –°–ª–æ–∂–Ω–æ—Å—Ç—å   |
| -------------------- | --------------- | ------------------ | ----------- |
| Atomic counter       | –Ω–∏–∑–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è  | –∑–∞–≤–∏—Å–∏—Ç –æ—Ç sleep   | –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç |
| Condition variable   | –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è     | –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è         | —Å—Ä–µ–¥–Ω—è—è     |
| Event queue          | —Å—Ä–µ–¥–Ω—è—è         | –≤—ã—Å–æ–∫–∞—è            | –≤—ã—à–µ        |
| Per-Sampler counters | —Å—Ä–µ–¥–Ω—è—è/–≤—ã—Å–æ–∫–∞—è | –≤—ã—Å–æ–∫–∞—è            | –≤—ã—à–µ        |

**–í—ã–≤–æ–¥:**

* **–ï—Å–ª–∏ —Ü–µ–ª—å ‚Äî —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –Ω–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ CPU:** `condition_variable` + event-driven wake-up.
* **–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø—Ä–æ—Å—Ç–æ—Ç–∞ –∏ batch-–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥:** `atomic counter / active_workers`.

üí° –°–æ–≤–µ—Ç: –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤ —Å T1/T2, –∫–æ—Ç–æ—Ä—ã–µ –±—ã—Å—Ç—Ä–æ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, **atomic counter + –Ω–µ–±–æ–ª—å—à–æ–π sleep (~5‚Äì10‚ÄØ–º—Å) –±—É–¥–µ—Ç –ø—Ä–æ—â–µ –∏ –ø–æ—á—Ç–∏ —Ç–∞–∫ –∂–µ –±—ã—Å—Ç—Ä–æ**, –∞ –¥–ª—è realtime-—Å–∏—Å—Ç–µ–º —Å –±–æ–ª—å—à–∏–º –ø–æ—Ç–æ–∫–æ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ª—É—á—à–µ `condition_variable`.

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —è –º–æ–≥—É —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑–∞—Ç—å **–º–∏–Ω–∏-—Å—Ö–µ–º—É –∏ –∫–æ–¥ –¥–ª—è T3**, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **atomic counter –∏ —É—Å–ª–æ–≤–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**, –≥–æ—Ç–æ–≤—É—é –¥–ª—è –∑–∞–ø—É—Å–∫–∞.

–•–æ—á–µ—à—å —Ç–∞–∫–æ–π –ø—Ä–∏–º–µ—Ä?



```mermaid
flowchart LR
  subgraph T1["Thread 1 (HAR parser)"]
    A1["entry[10] found variable seller_id"]
    A2["update variable_pool with index 10"]
    A3["notify T3 via condition_variable"]
    A4["set finished=true –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏"]
  end

  subgraph T2["Thread 2 (HAR parser)"]
    B1["entry[50] found variable seller_id"]
    B2["update variable_pool with index 50"]
    B3["notify T3 via condition_variable"]
    B4["set finished=true –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏"]
  end

  subgraph POOL["variable_pool"]
    P["seller_id:
       first_seen_index=10
       master_sampler=jmx[10]"]
  end

  subgraph T3["Thread 3 (Extractor manager)"]
    C1["wait on condition_variable"]
    C2["iterate variable_pool"]
    C3["create Extractor in master_sampler"]
    C4["replace values ${var} in master_sampler"]
    C5["exit when finished && pool empty"]
  end

  A1 --> A2 --> P
  B1 --> B2 --> P
  P --> C2 --> C3 --> C4
  A3 --> C1
  B3 --> C1
  A4 --> C5
  B4 --> C5

  style A1 fill:#cce5ff,stroke:#004085,stroke-width:2px,color:#000
  style A2 fill:#cce5ff,stroke:#004085,stroke-width:2px,color:#000
  style A3 fill:#cce5ff,stroke:#004085,stroke-width:2px,color:#000
  style A4 fill:#cce5ff,stroke:#004085,stroke-width:2px,color:#000
  style B1 fill:#cce5ff,stroke:#004085,stroke-width:2px,color:#000
  style B2 fill:#cce5ff,stroke:#004085,stroke-width:2px,color:#000
  style B3 fill:#cce5ff,stroke:#004085,stroke-width:2px,color:#000
  style B4 fill:#cce5ff,stroke:#004085,stroke-width:2px,color:#000
  style P fill:#fff3cd,stroke:#856404,stroke-width:1px,color:#000
  style C1 fill:#d4edda,stroke:#155724,stroke-width:1px,color:#000
  style C2 fill:#d4edda,stroke:#155724,stroke-width:1px,color:#000
  style C3 fill:#d4edda,stroke:#155724,stroke-width:1px,color:#000
  style C4 fill:#d4edda,stroke:#155724,stroke-width:1px,color:#000
  style C5 fill:#d4edda,stroke:#155724,stroke-width:1px,color:#000
```